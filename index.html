<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAC · Mercado vs Competidores · Siegfried</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --sie:       #8B1C1C;
    --sie-light: #b02626;
    --sie-pale:  #f9f0f0;
    --nav-bg:    #111318;
    --bg:        #f2f3f5;
    --surface:   #ffffff;
    --border:    #e2e4e8;
    --border2:   #d0d3d9;
    --text:      #1a1d23;
    --muted:     #6b7280;
    --muted2:    #9ca3af;
    --pill-bg:   #eef0f3;
    --pill-act:  #8B1C1C;
    --green:     #16a34a;
    --blue:      #2563eb;
    --amber:     #d97706;
    --purple:    #7c3aed;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px;
    min-height: 100vh;
  }

  /* ── TOP NAV ───────────────────────────────────────── */
  .topnav {
    background: var(--nav-bg);
    height: 48px;
    display: flex;
    align-items: center;
    padding: 0 28px;
    gap: 0;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid #2a2d35;
  }
  .logo {
    font-weight: 800;
    font-size: 14px;
    color: #fff;
    letter-spacing: .06em;
    margin-right: 32px;
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .logo-dot { width: 8px; height: 8px; background: var(--sie); border-radius: 50%; }
  .nav-tabs { display: flex; align-items: center; gap: 2px; flex: 1; }
  .nav-tab {
    color: #9ca3af;
    font-size: 12px;
    font-weight: 500;
    padding: 0 14px;
    height: 48px;
    display: flex;
    align-items: center;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color .15s, border-color .15s;
    white-space: nowrap;
  }
  .nav-tab:hover { color: #e5e7eb; }
  .nav-tab.active { color: #fff; border-bottom-color: var(--sie); }
  .nav-tag {
    background: var(--sie);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 4px;
    letter-spacing: .04em;
    margin-left: 8px;
  }
  .hub-link { color: #6b7280; font-size: 12px; margin-left: auto; cursor: pointer; white-space: nowrap; }
  .hub-link:hover { color: #d1d5db; }

  /* ── PAGE HEADER ───────────────────────────────────── */
  .page-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 28px 0;
  }
  .breadcrumb {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: .14em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .breadcrumb span { color: var(--sie); }
  .page-title {
    font-size: 26px;
    font-weight: 800;
    color: var(--text);
    line-height: 1.1;
    letter-spacing: -.3px;
  }
  .page-sub {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
    margin-bottom: 16px;
  }
  .segment-tabs { display: flex; gap: 0; border-top: 1px solid var(--border); margin-top: 4px; }
  .seg-tab {
    font-size: 12px;
    font-weight: 600;
    padding: 10px 18px;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all .15s;
    white-space: nowrap;
  }
  .seg-tab:hover { color: var(--text); }
  .seg-tab.active { color: var(--sie); border-bottom-color: var(--sie); }

  /* ── CONTENT WRAPPER ───────────────────────────────── */
  .content { max-width: 1360px; margin: 0 auto; padding: 20px 28px 48px; }

  /* ── YEAR FILTER BAR ───────────────────────────────── */
  .filter-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }
  .filter-lbl {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-right: 4px;
  }
  .yr-btn {
    background: var(--pill-bg);
    border: 1px solid transparent;
    color: var(--muted);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-weight: 600;
    font-size: 12px;
    padding: 5px 14px;
    border-radius: 20px;
    cursor: pointer;
    transition: all .15s;
    user-select: none;
  }
  .yr-btn:hover { border-color: var(--border2); color: var(--text); }
  .yr-btn.active { background: var(--sie); color: #fff; border-color: var(--sie); }
  .yr-btn.all-btn { font-size: 11px; letter-spacing: .05em; }
  .vl-period-btn {
    background: var(--pill-bg);
    border: 1px solid transparent;
    color: var(--muted);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-weight: 600;
    font-size: 12px;
    padding: 5px 14px;
    border-radius: 20px;
    cursor: pointer;
    transition: all .15s;
    user-select: none;
  }
  .vl-period-btn:hover { border-color: var(--border2); color: var(--text); }
  .vl-period-btn.active { background: var(--sie); color: #fff; border-color: var(--sie); }

  /* ── KPI CARDS ──────────────────────────────────────── */
  .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 18px; }
  @media(max-width:900px){ .kpi-row { grid-template-columns: 1fr 1fr; } }
  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px 14px;
    position: relative;
    overflow: hidden;
    animation: fadeUp .4s ease both;
  }
  .kpi-card::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
  }
  .kpi-card.c1::after { background: var(--sie); }
  .kpi-card.c2::after { background: var(--blue); }
  .kpi-card.c3::after { background: var(--green); }
  .kpi-card.c4::after { background: var(--purple); }
  .kpi-label {
    font-size: 9px; font-weight: 700; letter-spacing: .12em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 8px;
  }
  .kpi-value { font-size: 28px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .kpi-card.c1 .kpi-value { color: var(--sie); }
  .kpi-card.c2 .kpi-value { color: var(--blue); }
  .kpi-card.c3 .kpi-value { color: var(--green); }
  .kpi-card.c4 .kpi-value { color: var(--purple); }
  .kpi-desc { font-size: 11px; color: var(--muted); line-height: 1.4; }
  .kpi-sub { font-size: 10px; color: var(--muted2); margin-top: 6px; }

  /* ── COMPETITOR FILTER ─────────────────────────────── */
  .comp-filter-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 18px;
    animation: fadeUp .4s ease .1s both;
    position: sticky;
    top: 48px;
    z-index: 90;
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
  }
  .comp-filter-header {
    font-size: 9px; font-weight: 700; letter-spacing: .12em;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 10px;
  }
  .comp-filter-header span { color: var(--muted2); font-weight: 400; text-transform: none; letter-spacing: 0; font-size: 11px; margin-left: 6px; }
  .comp-pills { display: flex; flex-wrap: wrap; gap: 6px; }
  .comp-pill {
    display: flex; align-items: center; gap: 5px;
    background: var(--pill-bg);
    border: 1px solid transparent;
    border-radius: 20px;
    padding: 4px 11px 4px 8px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    transition: all .15s;
    user-select: none;
  }
  .comp-pill:hover { border-color: var(--border2); }
  .comp-pill.off { opacity: .35; }
  .comp-pill .cdot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  /* ── CHARTS GRID ────────────────────────────────────── */
  .charts-grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px 20px 16px;
    animation: fadeUp .4s ease both;
  }
  .chart-card:nth-child(1){animation-delay:.12s}
  .chart-card:nth-child(2){animation-delay:.18s}
  .chart-card:nth-child(3){animation-delay:.24s}
  .chart-card:nth-child(4){animation-delay:.30s}

  .chart-header { margin-bottom: 14px; }
  .chart-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--sie); color: #fff;
    font-size: 10px; font-weight: 800;
    margin-right: 8px; vertical-align: middle;
  }
  .chart-title {
    font-size: 14px; font-weight: 700; color: var(--text); display: inline;
  }
  .chart-sub { font-size: 11px; color: var(--muted); margin-top: 3px; }
  .chart-wrap { position: relative; height: 380px; }
  .chart-wrap.ms { height: 320px; }

  /* ── SECTION DIVIDER ────────────────────────────────── */
  .section-div {
    display: flex; align-items: center; gap: 12px;
    margin: 24px 0 16px;
    font-size: 10px; font-weight: 700; letter-spacing: .12em;
    text-transform: uppercase; color: var(--muted);
  }
  .section-div::before, .section-div::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  .source { font-size: 10px; color: var(--muted2); text-align: right; margin-top: 20px; }

  /* MAT Tables */
  .mat-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .mat-table thead tr { border-bottom: 2px solid var(--border); }
  .mat-table th {
    padding: 8px 12px; text-align: right;
    font-size: 11px; font-weight: 700; color: var(--muted);
    letter-spacing: .06em; text-transform: uppercase; white-space: nowrap;
  }
  .mat-table th:first-child { text-align: left; }
  .mat-table td {
    padding: 9px 12px; text-align: right;
    font-size: 12px; border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .mat-table td:first-child { text-align: left; }
  .mat-table tbody tr:last-child td { border-bottom: none; }
  .mat-table tbody tr:hover { background: var(--pill-bg); }
  .mat-prod { display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--text); }
  .mat-prod .dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
  .mat-prod.sie-row { color: var(--sie); }
  .mat-val { font-weight: 500; }
  .mat-val.sie-val { font-weight: 700; color: var(--sie); }
  .mat-delta {
    display: inline-flex; align-items: center;
    font-size: 10px; font-weight: 700; padding: 2px 7px;
    border-radius: 10px;
  }
  .mat-delta.up   { background: #dcfce7; color: #15803d; }
  .mat-delta.down { background: #fee2e2; color: #dc2626; }
  .mat-delta.flat { background: #f3f4f6; color: #6b7280; }
  .mat-total-row td { background: var(--pill-bg); font-weight: 700; border-top: 2px solid var(--border2); font-size: 11px; color: var(--muted); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<!-- TOP NAV -->
<nav class="topnav">
  <div class="logo"><div class="logo-dot"></div>SIEGFRIED</div>
  <div class="nav-tabs">
    <div class="nav-tab">Resumen</div>
    <div class="nav-tab">Venta Interna</div>
    <div class="nav-tab active">Mercado IQVIA</div>
    <div class="nav-tab">Recetas</div>
    <div class="nav-tab">Stock</div>
    <div class="nav-tab">Cobertura</div>
    <div class="nav-tab">Precios</div>
    <div class="nav-tag">NAC</div>
  </div>
  <div class="hub-link">— Hub</div>
</nav>

<!-- PAGE HEADER -->
<div class="page-header">
  <div class="breadcrumb"><span>SIEGFRIED</span> · N-ACETILCISTEÍNA · INTELIGENCIA DE MERCADOS</div>
  <div class="page-title">NAC · Mercado vs Competidores</div>
  <div class="page-sub">Market Share por Segmento · Producto · IQVIA 2022–2025</div>
  <div class="segment-tabs">
    <div class="seg-tab active" data-seg="rx" onclick="switchSeg('rx')">Bajo Receta (ETICO)</div>
    <div class="seg-tab" data-seg="vl" onclick="switchSeg('vl')">Venta Libre (VL)</div>
  </div>
</div>

<!-- CONTENT -->
<div class="content">

  <!-- KPI CARDS -->
  <div class="kpi-row" id="kpi-row"></div>

  <!-- COMPETITOR FILTER -->
  <div class="comp-filter-card">
    <div class="comp-filter-header">Filtro Global · Competidores <span>Clickeá para mostrar / ocultar</span></div>
    <div class="comp-pills" id="comp-pills"></div>
    <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border); display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
      <span class="filter-lbl">Año:</span>
      <button class="yr-btn active" data-year="2022">2022</button>
      <button class="yr-btn active" data-year="2023">2023</button>
      <button class="yr-btn active" data-year="2024">2024</button>
      <button class="yr-btn active" data-year="2025">2025</button>
      <button class="yr-btn all-btn" id="btn-all">Todos</button>
    </div>
    <div id="vl-period-filter" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); align-items:center; gap:6px; flex-wrap:wrap;">
      <span class="filter-lbl" style="color:var(--sie)">Período VL:</span>
      <button class="vl-period-btn active" data-period="all">Todo el período</button>
      <button class="vl-period-btn" data-period="pre">Pre Venta Libre <span style="color:var(--muted);font-weight:400">2022–2024</span></button>
      <button class="vl-period-btn" data-period="post">Post Venta Libre <span style="color:var(--sie);font-weight:400">Ene 2025 →</span></button>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-header">
        <span class="chart-num">01</span>
        <span class="chart-title">Unidades Mensuales</span>
        <div class="chart-sub" id="sub-u">Siegfried · Nacional</div>
      </div>
      <div class="chart-wrap"><canvas id="chartU"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <span class="chart-num">02</span>
        <span class="chart-title">MS% Mensual · Competidores</span>
        <div class="chart-sub" id="sub-ms">Top competidores · Nacional</div>
      </div>
      <div class="chart-wrap ms"><canvas id="chartMs"></canvas></div>
    </div>
  </div>

  <!-- MAT ROLLING LINE CHARTS -->
  <div style="margin-top:14px">
    <div class="charts-grid">
      <div class="chart-card" style="animation-delay:.48s">
        <div class="chart-header">
          <span class="chart-num" style="background:#374151">05</span>
          <span class="chart-title">MAT Dic · Unidades</span>
          <div class="chart-sub">Acumulado 12 meses cierre diciembre · 2021–2025 <span style="color:#d97706;font-size:10px">*2021 = 11 meses (Feb–Dic)</span></div>
        </div>
        <div class="chart-wrap" style="height:380px"><canvas id="chartMatRollingU"></canvas></div>
      </div>
      <div class="chart-card" style="animation-delay:.54s">
        <div class="chart-header">
          <span class="chart-num" style="background:#374151">06</span>
          <span class="chart-title">MAT Dic · MS%</span>
          <div class="chart-sub">Market Share acumulado cierre diciembre · 2021–2025</div>
        </div>
        <div class="chart-wrap" style="height:380px"><canvas id="chartMatRollingMs"></canvas></div>
      </div>
    </div>
  </div>

  <!-- MAT TABLES -->
  <div style="margin-top:14px">
    <div class="charts-grid">

      <div class="chart-card" style="animation-delay:.36s">
        <div class="chart-header">
          <span class="chart-num">03</span>
          <span class="chart-title">MS% MAT · Bajo Receta (ETICO)</span>
          <div class="chart-sub">Participación anual acumulada por producto</div>
        </div>
        <div id="tableMatRx"></div>
      </div>

      <div class="chart-card" style="animation-delay:.42s">
        <div class="chart-header">
          <span class="chart-num">04</span>
          <span class="chart-title">MS% MAT · Venta Libre (VL)</span>
          <div class="chart-sub">Participación anual acumulada por producto</div>
        </div>
        <div id="tableMatVl"></div>
      </div>

    </div>
  </div>

  <!-- FULL NAC MARKET CHART -->
  <div style="margin-top:14px">
    <div class="chart-card" style="animation-delay:.60s">
      <div class="chart-header" style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:12px;">
        <div>
          <span class="chart-num" style="background:#374151">07</span>
          <span class="chart-title">Mercado NAC Completo · Unidades + MS% Acemuk</span>
          <div class="chart-sub">Todos los períodos disponibles · Feb 2021 – Ene 2026 · Bajo Receta + Venta Libre</div>
        </div>
        <div style="display:flex; gap:12px; align-items:center; font-size:11px; font-weight:600; color:var(--muted); flex-wrap:wrap;">
          <span><span style="display:inline-block;width:12px;height:12px;background:#8B1C1C;border-radius:2px;margin-right:5px;vertical-align:middle"></span>Bajo Receta</span>
          <span><span style="display:inline-block;width:12px;height:12px;background:#8B1C1C55;border-radius:2px;margin-right:5px;vertical-align:middle"></span>Venta Libre</span>
          <span><span style="display:inline-block;width:28px;height:2.5px;background:#2563eb;margin-right:5px;vertical-align:middle;border-radius:2px"></span>MS% Acemuk Total</span>
        </div>
      </div>
      <div style="position:relative; height:420px"><canvas id="chartNacTotal"></canvas></div>
    </div>
  </div>

  <!-- COMPETITOR UNITS + MS% LINE CHARTS -->
  <div style="margin-top:14px">
    <div class="chart-card" style="animation-delay:.66s">
      <div class="chart-header">
        <span class="chart-num" style="background:#374151">08</span>
        <span class="chart-title">Unidades por Marca · NAC Total</span>
        <div class="chart-sub">Todos los períodos · Feb 2021 – Ene 2026 · Acemuk vs Competidores</div>
      </div>
      <div style="position:relative; height:420px"><canvas id="chartCompUnits"></canvas></div>
    </div>
  </div>

  <div style="margin-top:14px">
    <div class="chart-card" style="animation-delay:.72s">
      <div class="chart-header">
        <span class="chart-num" style="background:#374151">09</span>
        <span class="chart-title">MS% por Marca · NAC Total</span>
        <div class="chart-sub">Todos los períodos · Feb 2021 – Ene 2026 · Market Share mensual</div>
      </div>
      <div style="position:relative; height:420px"><canvas id="chartCompMs"></canvas></div>
    </div>
  </div>

  <div class="source">Fuente: IQVIA · AR_PM_FV_Standard · Feb 2026 · Unidades mensuales por producto</div>

</div>

<script>
// ─── DATA ────────────────────────────────────────────────────────────────
const ALL_LABELS = ["Jan 2022","Feb 2022","Mar 2022","Apr 2022","May 2022","Jun 2022","Jul 2022","Aug 2022","Sep 2022","Oct 2022","Nov 2022","Dec 2022","Jan 2023","Feb 2023","Mar 2023","Apr 2023","May 2023","Jun 2023","Jul 2023","Aug 2023","Sep 2023","Oct 2023","Nov 2023","Dec 2023","Jan 2024","Feb 2024","Mar 2024","Apr 2024","May 2024","Jun 2024","Jul 2024","Aug 2024","Sep 2024","Oct 2024","Nov 2024","Dec 2024","Jan 2025","Feb 2025","Mar 2025","Apr 2025","May 2025","Jun 2025","Jul 2025","Aug 2025","Sep 2025","Oct 2025","Nov 2025","Dec 2025"];

const SEG_DATA = {
  rx: {
    units: {
      "ACEMUK (SIE)":         [367401,197632,305661,352912,499517,556234,496251,354041,352131,411542,310760,237131,131575,94680,173469,266792,392313,501655,436027,373298,347992,289416,186146,141847,134008,115170,130227,202331,441831,521177,448576,374452,340198,259027,180726,159305,133921,142783,234579,354129,377606,508133,519619,322891,337096,273060,214671,169394],
      "TOFLUX (CSO)":         [21136,18225,22353,26506,32687,44648,39797,27396,26958,28864,28589,13127,9519,6756,11097,18959,30756,47410,41018,34372,30828,27929,16743,10829,10386,8371,10053,15201,36571,57696,39330,32156,29386,23319,13491,11490,8798,8140,17826,29664,33060,42297,34843,27445,28981,22724,15050,11925],
      "TUKOL AC 600 (G3A)":  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15924,10675,14445,11383,19789,22565,8495,7895,6195,3391,3272],
      "DOSOMUK (BET)":        [3395,2332,1684,6378,6248,3943,6939,2696,4314,2584,2339,2445,1452,1218,4052,4447,5492,6811,7438,4324,4910,3161,3765,2305,1949,2678,4307,5081,7918,9944,7351,7058,5417,5076,2129,1609,1282,1327,2926,5579,4459,5763,5358,3518,4080,2442,1471,1567],
      "TOFLUX JARABE (CSO)":  [3399,1694,4477,9636,15728,23117,23899,10002,7903,16733,12892,3098,1857,1426,3054,5760,9649,10714,7526,6171,6133,5051,3513,2040,1332,1306,1945,3049,6667,9287,5846,4952,4816,3267,2185,1512,987,1067,2457,3797,4358,6078,4536,4141,4301,2888,2087,1560],
      "QURA MUK (BEB)":       [6032,4636,5926,7944,7752,4663,327,2036,2762,2976,2394,1547,958,558,1069,1828,2748,3907,3985,3483,3228,2427,1573,990,1201,807,847,1229,3539,5430,3937,3351,2892,2024,1183,872,652,576,1633,1997,2094,3048,2227,2043,2029,1334,971,787],
      "BISTRONFOR (ISA)":     [2396,1416,1443,1888,1775,2985,3449,2247,2512,2311,1716,1663,1555,657,1037,2426,3673,4148,3944,3527,2799,1844,1331,1072,966,1000,509,586,1711,3276,1068,1043,855,755,775,1000,1354,973,1540,2797,2895,5103,1326,1339,1322,1288,1214,126],
      "BRONCOLIUM (T.L)":     [3134,3114,2263,2341,3536,3924,3303,2653,1920,1967,2108,1307,1006,1183,1199,1791,2324,3245,2760,2275,1841,1415,1232,803,795,648,660,935,1766,2065,1802,1405,1667,983,790,740,1002,1284,1241,1927,2467,2570,3194,1823,1692,2618,714,725],
      "DENVERMUC (DEN)":      [940,960,1073,1141,1698,1622,1100,1376,1290,1895,847,1141,886,433,731,1215,1369,2268,2442,2587,1831,1780,1081,735,851,505,660,1065,2321,2789,2638,1822,1841,1715,1835,687,554,569,1826,1653,1545,2396,1615,1185,2249,1214,1205,716],
      "DEXALERGIN MUC (TEV)": [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1922,2085,592,825,372,846,846,762,1796,2709,2126,2449,1453,825,962,1457],
    },
    ms: {
      "ACEMUK (SIE)":         [88.4,83.7,86.9,85.0,86.2,85.2,85.4,86.2,87.2,87.1,85.3,90.2,87.9,88.1,87.1,86.9,86.7,85.9,86.0,86.4,86.7,86.6,86.0,87.8,88.0,86.5,86.0,87.2,87.3,84.3,86.6,86.5,86.3,85.4,87.8,88.6,89.5,82.0,84.6,84.7,85.3,84.8,86.7,85.7,85.9,86.5,88.5,88.2],
      "TOFLUX (CSO)":         [5.1,7.7,6.4,6.4,5.6,6.8,6.8,6.7,6.7,6.1,7.8,5.0,6.4,6.3,5.6,6.2,6.8,8.1,8.1,8.0,7.7,8.4,7.7,6.7,6.8,6.3,6.6,6.6,7.2,9.3,7.6,7.4,7.5,7.7,6.6,6.4,5.9,4.7,6.4,7.1,7.5,7.1,5.8,7.3,7.4,7.2,6.2,6.2],
      "TUKOL AC 600 (G3A)":  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9.1,3.8,3.5,2.6,3.3,3.8,2.3,2.0,2.0,1.4,1.7],
      "DOSOMUK (BET)":        [0.8,1.0,0.5,1.5,1.1,0.6,1.2,0.7,1.1,0.5,0.6,0.9,1.0,1.1,2.0,1.4,1.2,1.2,1.5,1.0,1.2,0.9,1.7,1.4,1.3,2.0,2.8,2.2,1.6,1.6,1.4,1.6,1.4,1.7,1.0,0.9,0.9,0.8,1.1,1.3,1.0,1.0,0.9,0.9,1.0,0.8,0.6,0.8],
      "TOFLUX JARABE (CSO)":  [0.8,0.7,1.3,2.3,2.7,3.5,4.1,2.4,2.0,3.5,3.5,1.2,1.2,1.3,1.5,1.9,2.1,1.8,1.5,1.4,1.5,1.5,1.6,1.3,0.9,1.0,1.3,1.3,1.3,1.5,1.1,1.1,1.2,1.1,1.1,0.8,0.7,0.6,0.9,0.9,1.0,1.0,0.8,1.1,1.1,0.9,0.9,0.8],
      "QURA MUK (BEB)":       [1.5,2.0,1.7,1.9,1.3,0.7,0.1,0.5,0.7,0.6,0.7,0.6,0.6,0.5,0.5,0.6,0.6,0.7,0.8,0.8,0.8,0.7,0.7,0.6,0.8,0.6,0.6,0.5,0.7,0.9,0.8,0.8,0.7,0.7,0.6,0.5,0.4,0.3,0.6,0.5,0.5,0.5,0.4,0.5,0.5,0.4,0.4,0.4],
      "BISTRONFOR (ISA)":     [0.6,0.6,0.4,0.5,0.3,0.5,0.6,0.5,0.6,0.5,0.5,0.6,1.0,0.6,0.5,0.8,0.8,0.7,0.8,0.8,0.7,0.6,0.6,0.7,0.6,0.8,0.3,0.3,0.3,0.5,0.2,0.2,0.2,0.2,0.4,0.6,0.9,0.6,0.6,0.7,0.7,0.9,0.2,0.4,0.3,0.4,0.5,0.1],
      "BRONCOLIUM (T.L)":     [0.8,1.3,0.6,0.6,0.6,0.6,0.6,0.6,0.5,0.4,0.6,0.5,0.7,1.1,0.6,0.6,0.5,0.6,0.5,0.5,0.5,0.4,0.6,0.5,0.5,0.5,0.4,0.4,0.3,0.3,0.3,0.3,0.4,0.3,0.4,0.4,0.7,0.7,0.4,0.5,0.6,0.4,0.5,0.5,0.4,0.8,0.3,0.4],
      "DENVERMUC (DEN)":      [0.2,0.4,0.3,0.3,0.3,0.2,0.2,0.3,0.3,0.4,0.2,0.4,0.6,0.4,0.4,0.4,0.3,0.4,0.5,0.6,0.5,0.5,0.5,0.5,0.6,0.4,0.4,0.5,0.5,0.5,0.5,0.4,0.5,0.6,0.9,0.4,0.4,0.3,0.7,0.4,0.3,0.4,0.3,0.3,0.6,0.4,0.5,0.4],
      "DEXALERGIN MUC (TEV)": [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.5,0.7,0.3,0.5,0.2,0.5,0.3,0.2,0.4,0.5,0.4,0.6,0.4,0.3,0.4,0.8],
    },
    kpi: {
      ms2025: '85.7%', units2025: '3.59M', label: 'ACEMUK (SIE)', marketLabel: 'INHIBID EXPECTORANTE', total2025: '4.18M u. mercado'
    }
  },
  vl: {
    units: {
      "ACEMUK VL (SIE)":    [25673,14824,29267,33437,49587,55086,40348,24961,30722,36984,28676,16176,9276,7621,15310,21933,36026,44449,34922,29423,27423,22826,15520,10261,8661,7790,11091,17286,38345,43453,28201,25900,24943,18569,13434,5129,5262,9076,8798,14304,12128,21649,21635,10630,10192,9781,8715,4564],
      "TOFLUX VL (CSO)":    [2466,1761,3400,4664,5913,8363,5806,3467,3725,4376,4361,1811,1462,1304,1890,3144,4503,5576,4692,3754,3940,3121,2428,1740,1492,1088,1574,1818,3808,5881,3871,3607,2962,2304,1524,647,527,517,957,1363,1618,1960,1661,1258,1078,852,649,458],
      "CEDRIMUC (ELE)":     [1701,2768,4799,1596,2597,3338,1877,1729,759,900,700,1066,4910,11661,6954,1634,1292,2678,4757,3513,1907,1247,744,494,399,282,309,528,2106,1533,2457,1877,1081,897,519,377,1784,1650,2115,895,1398,1824,1809,918,858,676,489,146],
      "TUKOL AC 200 (G3A)": [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2377,4944,2740,1991,1542,1410,965,423,393,255,214],
    },
    ms: {
      "ACEMUK VL (SIE)":    [86.0,76.6,78.1,84.2,85.4,82.5,84.0,82.8,87.3,87.5,85.0,84.9,59.3,37.0,63.4,82.1,86.1,84.3,78.7,80.2,82.4,83.9,83.0,82.1,82.1,85.0,85.5,88.1,86.6,85.4,81.7,82.5,86.1,85.3,86.8,83.4,69.5,66.6,52.3,74.1,70.8,80.3,81.6,77.2,81.2,83.6,86.2,84.8],
      "TOFLUX VL (CSO)":    [8.3,9.1,9.1,11.7,10.2,12.5,12.1,11.5,10.6,10.4,12.9,9.5,9.3,6.3,7.8,11.8,10.8,10.6,10.6,10.2,11.8,11.5,13.0,13.9,14.1,11.9,12.1,9.3,8.6,11.6,11.2,11.5,10.2,10.6,9.8,10.5,7.0,3.8,5.7,7.1,9.4,7.3,6.3,9.1,8.6,7.3,6.4,8.5],
      "CEDRIMUC (ELE)":     [5.7,14.3,12.8,4.0,4.5,5.0,3.9,5.7,2.2,2.1,2.1,5.6,31.4,56.6,28.8,6.1,3.1,5.1,10.7,9.6,5.7,4.6,4.0,4.0,3.8,3.1,2.4,2.7,4.8,3.0,7.1,6.0,3.7,4.1,3.4,6.1,23.6,12.1,12.6,4.6,8.2,6.8,6.8,6.7,6.8,5.8,4.8,2.7],
      "TUKOL AC 200 (G3A)": [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17.5,29.4,14.2,11.6,5.7,5.3,7.0,3.4,3.4,2.5,4.0],
    },
    kpi: {
      ms2025: '75.4%', units2025: '136.7K', label: 'ACEMUK VL (SIE)', marketLabel: 'VL EXPECTORANTE', total2025: '181.4K u. mercado'
    }
  }
};

const COLORS = {
  "ACEMUK (SIE)":         '#8B1C1C',
  "TOFLUX (CSO)":         '#2563eb',
  "TUKOL AC 600 (G3A)":  '#16a34a',
  "DOSOMUK (BET)":        '#7c3aed',
  "TOFLUX JARABE (CSO)":  '#d97706',
  "QURA MUK (BEB)":       '#0891b2',
  "BISTRONFOR (ISA)":     '#be185d',
  "BRONCOLIUM (T.L)":     '#059669',
  "DENVERMUC (DEN)":      '#6b7280',
  "DEXALERGIN MUC (TEV)": '#9333ea',
  "ACEMUK VL (SIE)":      '#8B1C1C',
  "TOFLUX VL (CSO)":      '#2563eb',
  "CEDRIMUC (ELE)":       '#7c3aed',
  "TUKOL AC 200 (G3A)":  '#16a34a',
};

const ALL_YEARS = ['2022','2023','2024','2025'];
let activeYears = new Set(ALL_YEARS);
let activeSeg = 'rx';
let activeComps = new Set();
let vlPeriod = 'all'; // 'all' | 'pre' | 'post'

// Jan 2025 index in ALL_LABELS
const VL_START_LABEL = 'Jan 2025';
const VL_START_IDX = ALL_LABELS.indexOf(VL_START_LABEL); // 36

// ─── Inflection line plugin ───────────────────────────────────
const inflectionLinePlugin = {
  id: 'inflectionLine',
  afterDraw(chart) {
    if (!chart.config.options._showInflection) return;
    const labels = chart.data.labels || [];
    const idx = labels.indexOf(VL_START_LABEL);
    if (idx === -1) return;

    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data[idx]) return;
    const x = meta.data[idx].x;
    const { top, bottom } = chart.chartArea;
    const ctx = chart.ctx;

    ctx.save();
    // shaded region post-VL
    ctx.fillStyle = 'rgba(139,28,28,0.04)';
    ctx.fillRect(x, top, chart.chartArea.right - x, bottom - top);

    // dashed vertical line
    ctx.beginPath();
    ctx.setLineDash([5, 4]);
    ctx.strokeStyle = '#8B1C1C';
    ctx.lineWidth = 1.5;
    ctx.moveTo(x, top);
    ctx.lineTo(x, bottom);
    ctx.stroke();
    ctx.setLineDash([]);

    // label badge
    const badgeW = 76, badgeH = 18, badgeX = x + 5, badgeY = top + 8;
    ctx.fillStyle = '#8B1C1C';
    ctx.beginPath();
    ctx.roundRect(badgeX, badgeY, badgeW, badgeH, 3);
    ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = "600 10px 'Plus Jakarta Sans', sans-serif";
    ctx.textBaseline = 'middle';
    ctx.fillText('→ Inicio VL', badgeX + 6, badgeY + badgeH / 2);
    ctx.restore();
  }
};
Chart.register(inflectionLinePlugin);

// init active comps
function initActiveComps() {
  activeComps.clear();
  Object.keys(SEG_DATA[activeSeg].units).forEach(k => activeComps.add(k));
}
initActiveComps();

// ─── KPI render ──────────────────────────────────────────────
function renderKpi() {
  const d = SEG_DATA[activeSeg];
  const seg = activeSeg === 'rx' ? 'Bajo Receta' : 'Venta Libre';
  // compute last available MS for acemuk
  document.getElementById('kpi-row').innerHTML = `
    <div class="kpi-card c1" style="animation-delay:.05s">
      <div class="kpi-label">MS% · Nacional · 2025</div>
      <div class="kpi-value">${d.kpi.ms2025}</div>
      <div class="kpi-desc">${d.kpi.label}</div>
      <div class="kpi-sub">${d.kpi.total2025}</div>
    </div>
    <div class="kpi-card c2" style="animation-delay:.08s">
      <div class="kpi-label">Unidades SIE · 2025</div>
      <div class="kpi-value">${d.kpi.units2025}</div>
      <div class="kpi-desc">${d.kpi.label}</div>
      <div class="kpi-sub">${seg}</div>
    </div>
    <div class="kpi-card c3" style="animation-delay:.11s">
      <div class="kpi-label">MS% Dic '25 · Nacional</div>
      <div class="kpi-value">${activeSeg==='rx'?'88.2%':'84.8%'}</div>
      <div class="kpi-desc">Último mes</div>
      <div class="kpi-sub">vs. ${activeSeg==='rx'?'<span style="color:#16a34a">▲ 2.4pp</span>':'<span style="color:#16a34a">▲ 9.4pp</span>'} vs MAT Dic '25 (${activeSeg==='rx'?'85.8%':'75.4%'})</div>
    </div>
    <div class="kpi-card c4" style="animation-delay:.14s">
      <div class="kpi-label">Tendencia 2022→2025</div>
      <div class="kpi-value">${activeSeg==='rx'?'−19.3%':'−60.5%'}</div>
      <div class="kpi-desc">Variación total mercado</div>
      <div class="kpi-sub">5.61M → ${activeSeg==='rx'?'4.18M':'181K'} u.</div>
    </div>`;
}

// ─── Competitor pills ─────────────────────────────────────────
function renderCompPills() {
  const container = document.getElementById('comp-pills');
  container.innerHTML = '';
  const prods = Object.keys(SEG_DATA[activeSeg].units);
  prods.forEach(label => {
    const c = COLORS[label] || '#888';
    const pill = document.createElement('div');
    pill.className = 'comp-pill' + (activeComps.has(label) ? '' : ' off');
    pill.dataset.label = label;
    pill.innerHTML = `<div class="cdot" style="background:${c}"></div>${label}`;
    pill.addEventListener('click', () => {
      if (activeComps.has(label)) {
        if (activeComps.size === 1) return;
        activeComps.delete(label);
        pill.classList.add('off');
      } else {
        activeComps.add(label);
        pill.classList.remove('off');
      }
      refreshCharts();
      buildMatRollingCharts();
      buildCompCharts();
    });
    container.appendChild(pill);
  });
}

// ─── Filter by years ─────────────────────────────────────────
function filterByYears(rawData) {
  let indices = ALL_LABELS.reduce((acc, l, i) => {
    const yr = l.split(' ')[1];
    if (activeYears.has(yr)) acc.push(i);
    return acc;
  }, []);

  // Apply VL period filter
  if (activeSeg === 'vl' && vlPeriod !== 'all') {
    indices = indices.filter(i => {
      return vlPeriod === 'pre' ? i < VL_START_IDX : i >= VL_START_IDX;
    });
  }

  const labels = indices.map(i => ALL_LABELS[i]);
  const filtered = {};
  Object.entries(rawData).forEach(([k, arr]) => { filtered[k] = indices.map(i => arr[i]); });
  return { labels, filtered };
}

// ─── Chart.js defaults ───────────────────────────────────────
Chart.defaults.color = '#9ca3af';
Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
Chart.defaults.font.size = 11;

function makeDatasets(filteredData, isSie, isMs) {
  return Object.entries(filteredData)
    .filter(([label]) => activeComps.has(label))
    .map(([label, data]) => {
      const isSiegfried = label.includes('(SIE)');
      return {
        label,
        data,
        borderColor: COLORS[label] || '#888',
        backgroundColor: isSiegfried ? (COLORS[label] + '18') : 'transparent',
        borderWidth: isSiegfried ? 2.5 : 1.5,
        pointRadius: isSiegfried ? (data.length > 30 ? 3 : 5) : (data.length > 30 ? 1.5 : 3),
        pointHoverRadius: 6,
        pointBackgroundColor: isSiegfried ? COLORS[label] : '#fff',
        pointBorderColor: COLORS[label],
        pointBorderWidth: isSiegfried ? 0 : 1.5,
        tension: 0.35,
        fill: isSiegfried,
      };
    });
}

function chartOpts(isMs) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: {
        display: true,
        position: 'bottom',
        labels: {
          boxWidth: 10, boxHeight: 10,
          padding: 12,
          font: { size: 10, family: "'Plus Jakarta Sans', sans-serif" },
          color: '#6b7280',
          usePointStyle: true, pointStyle: 'circle',
        }
      },
      tooltip: {
        backgroundColor: '#fff',
        borderColor: '#e2e4e8',
        borderWidth: 1,
        padding: 10,
        titleColor: '#1a1d23',
        bodyColor: '#6b7280',
        titleFont: { family: "'Plus Jakarta Sans', sans-serif", weight: '700', size: 12 },
        bodyFont: { family: "'Plus Jakarta Sans', sans-serif", size: 11 },
        callbacks: {
          label: ctx => {
            const v = ctx.parsed.y;
            if (v === 0) return null;
            return isMs
              ? ` ${ctx.dataset.label}: ${v.toFixed(1)}%`
              : ` ${ctx.dataset.label}: ${v.toLocaleString('es-AR')} u.`;
          }
        }
      }
    },
    scales: {
      x: {
        grid: { color: '#f3f4f6', drawBorder: false },
        border: { display: false },
        ticks: {
          maxTicksLimit: 24,
          callback(val, i) {
            const l = this.getLabelForValue(i);
            return l && l.startsWith('Jan') ? l : (l ? l.split(' ')[0] : '');
          },
          font: { size: 10, family: "'Plus Jakarta Sans', sans-serif" },
          color: ctx => {
            const l = ctx.tick?.label;
            return typeof l === 'string' && l.startsWith('Jan') ? '#374151' : '#9ca3af';
          },
          maxRotation: 0,
        }
      },
      y: {
        grid: { color: '#f3f4f6', drawBorder: false },
        border: { display: false, dash: [4, 4] },
        ticks: {
          callback: isMs
            ? v => v + '%'
            : v => v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v,
          font: { size: 10 },
        },
        ...(isMs ? { min: 0, max: 100 } : {})
      }
    }
  };
}

// Build charts
let { labels: labInit, filtered: fUInit } = filterByYears(SEG_DATA.rx.units);
let { filtered: fMsInit } = filterByYears(SEG_DATA.rx.ms);

const chartU  = new Chart(document.getElementById('chartU'),  { type:'line', data:{ labels: labInit, datasets: makeDatasets(fUInit,  true, false) }, options: chartOpts(false) });
const chartMs = new Chart(document.getElementById('chartMs'), { type:'line', data:{ labels: labInit, datasets: makeDatasets(fMsInit, true, true)  }, options: chartOpts(true)  });

function refreshCharts() {
  const d = SEG_DATA[activeSeg];
  const isVl = activeSeg === 'vl';
  const showLine = isVl && vlPeriod === 'all' && activeYears.has('2025') && activeYears.has('2024');
  const { labels, filtered: fu  } = filterByYears(d.units);
  const { filtered: fms } = filterByYears(d.ms);

  [chartU, chartMs].forEach(c => {
    c.data.labels = labels;
    c.options._showInflection = showLine;
  });
  chartU.data.datasets  = makeDatasets(fu,  true, false);
  chartMs.data.datasets = makeDatasets(fms, true, true);
  [chartU, chartMs].forEach(c => c.update());
}

// ─── Segment switch ───────────────────────────────────────────
function switchSeg(seg) {
  activeSeg = seg;
  document.querySelectorAll('.seg-tab').forEach(t => t.classList.toggle('active', t.dataset.seg === seg));
  // Show/hide VL period filter
  const vlFilter = document.getElementById('vl-period-filter');
  vlFilter.style.display = seg === 'vl' ? 'flex' : 'none';
  // Reset VL period when switching away
  if (seg !== 'vl') { vlPeriod = 'all'; }
  initActiveComps();
  renderKpi();
  renderCompPills();
  refreshCharts();
  buildMatRollingCharts();
  buildCompCharts();
}

// ─── Year buttons ─────────────────────────────────────────────
document.querySelectorAll('.yr-btn[data-year]').forEach(btn => {
  btn.addEventListener('click', () => {
    const yr = btn.dataset.year;
    if (activeYears.has(yr)) {
      if (activeYears.size === 1) return;
      activeYears.delete(yr);
      btn.classList.remove('active');
    } else {
      activeYears.add(yr);
      btn.classList.add('active');
    }
    refreshCharts();
    buildCompCharts();
  });
});
document.getElementById('btn-all').addEventListener('click', () => {
  ALL_YEARS.forEach(y => activeYears.add(y));
  document.querySelectorAll('.yr-btn[data-year]').forEach(b => b.classList.add('active'));
  refreshCharts();
  buildCompCharts();
});

// ─── VL Period filter ─────────────────────────────────────────
document.querySelectorAll('.vl-period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    vlPeriod = btn.dataset.period;
    document.querySelectorAll('.vl-period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Auto-set year buttons to match period
    if (vlPeriod === 'pre') {
      activeYears = new Set(['2022','2023','2024']);
      document.querySelectorAll('.yr-btn[data-year]').forEach(b => {
        b.classList.toggle('active', b.dataset.year !== '2025');
      });
    } else if (vlPeriod === 'post') {
      activeYears = new Set(['2025']);
      document.querySelectorAll('.yr-btn[data-year]').forEach(b => {
        b.classList.toggle('active', b.dataset.year === '2025');
      });
    } else {
      activeYears = new Set(ALL_YEARS);
      document.querySelectorAll('.yr-btn[data-year]').forEach(b => b.classList.add('active'));
    }
    refreshCharts();
  });
});

// ─── MAT DIC SNAPSHOT DATA ────────────────────────────────────
const MAT_DIC_LABELS = ['MAT Dic 2021','MAT Dic 2022','MAT Dic 2023','MAT Dic 2024','MAT Dic 2025'];

const MAT_DIC = {
  rx: {
    u: {
      "ACEMUK (SIE)":         [2349193,4441213,3335210,3307028,3587882],
      "TOFLUX (CSO)":         [161331,330286,286216,287450,280753],
      "TUKOL AC 600 (G3A)":  [0,0,0,0,124029],
      "DOSOMUK (BET)":        [20315,45297,49375,60517,39772],
      "TOFLUX JARABE (CSO)":  [34888,132578,62894,46164,38257],
      "QURA MUK (BEB)":       [30932,48995,26754,27312,19391],
      "BISTRONFOR (ISA)":     [13441,25801,28013,13544,21277],
      "BRONCOLIUM (T.L)":     [15574,31570,21074,14256,21257],
      "DENVERMUC (DEN)":      [4932,15083,17358,18729,16727],
      "DEXALERGIN MUC (TEV)": [0,0,0,5424,16603],
    },
    ms: {
      "ACEMUK (SIE)":         [87.6,86.3,86.6,86.4,85.8],
      "TOFLUX (CSO)":         [6.0,6.4,7.4,7.5,6.7],
      "TUKOL AC 600 (G3A)":  [0,0,0,0,3.0],
      "DOSOMUK (BET)":        [0.8,0.9,1.3,1.6,1.0],
      "TOFLUX JARABE (CSO)":  [1.3,2.6,1.6,1.2,0.9],
      "QURA MUK (BEB)":       [1.2,1.0,0.7,0.7,0.5],
      "BISTRONFOR (ISA)":     [0.5,0.5,0.7,0.4,0.5],
      "BRONCOLIUM (T.L)":     [0.6,0.6,0.5,0.4,0.5],
      "DENVERMUC (DEN)":      [0.2,0.3,0.5,0.5,0.4],
      "DEXALERGIN MUC (TEV)": [0,0,0,0.1,0.4],
    }
  },
  vl: {
    u: {
      "ACEMUK VL (SIE)":    [74403,385741,274990,242802,136734],
      "TOFLUX VL (CSO)":    [11422,50113,37554,30576,12898],
      "CEDRIMUC (ELE)":     [24774,23830,41791,12365,14562],
      "TUKOL AC 200 (G3A)": [0,0,0,0,17254],
    },
    ms: {
      "ACEMUK VL (SIE)":    [67.3,83.9,77.6,85.0,75.4],
      "TOFLUX VL (CSO)":    [10.3,10.9,10.6,10.7,7.1],
      "CEDRIMUC (ELE)":     [22.4,5.2,11.8,4.3,8.0],
      "TUKOL AC 200 (G3A)": [0,0,0,0,9.5],
    }
  }
};

function buildMatRollingCharts() {
  const seg = MAT_DIC[activeSeg];

  ['chartMatRollingU','chartMatRollingMs'].forEach(id => {
    const existing = Chart.getChart(id);
    if (existing) existing.destroy();
  });

  function makeDs(dataObj, isMs) {
    return Object.entries(dataObj)
      .filter(([label]) => activeComps.has(label))
      .map(([label, data]) => {
        const isSie = label.includes('(SIE)');
        return {
          label,
          data,
          borderColor: COLORS[label] || '#888',
          backgroundColor: isSie ? (COLORS[label] + '15') : 'transparent',
          borderWidth: isSie ? 3 : 2,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: isSie ? COLORS[label] : '#fff',
          pointBorderColor: COLORS[label],
          pointBorderWidth: isSie ? 0 : 2,
          tension: 0.3,
          fill: isSie,
        };
      });
  }

  function dicOpts(isMs) {
    return {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: true, position: 'bottom',
          labels: { boxWidth: 10, boxHeight: 10, padding: 12, font: { size: 10, family: "'Plus Jakarta Sans', sans-serif" }, color: '#6b7280', usePointStyle: true, pointStyle: 'circle' }
        },
        tooltip: {
          backgroundColor: '#fff', borderColor: '#e2e4e8', borderWidth: 1, padding: 10,
          titleColor: '#1a1d23', bodyColor: '#6b7280',
          titleFont: { family: "'Plus Jakarta Sans', sans-serif", weight: '700', size: 12 },
          bodyFont: { family: "'Plus Jakarta Sans', sans-serif", size: 11 },
          callbacks: {
            label: ctx => {
              const v = ctx.parsed.y;
              if (v === 0) return null;
              return isMs
                ? ` ${ctx.dataset.label}: ${v.toFixed(1)}%`
                : ` ${ctx.dataset.label}: ${v.toLocaleString('es-AR')} u.`;
            },
            afterTitle: ctx => ctx[0]?.label === 'MAT Dic 2021' ? '⚠ 11 meses (Feb–Dic 2021)' : ''
          }
        }
      },
      scales: {
        x: {
          grid: { color: '#f3f4f6' }, border: { display: false },
          ticks: {
            font: { size: 11, weight: '600', family: "'Plus Jakarta Sans', sans-serif" },
            color: '#374151',
            maxRotation: 0,
          }
        },
        y: {
          grid: { color: '#f3f4f6' }, border: { display: false },
          ticks: {
            callback: isMs ? v => v + '%' : v => v >= 1e6 ? (v/1e6).toFixed(2)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v,
            font: { size: 10 },
          },
          ...(isMs ? { min: 0, max: 100 } : { beginAtZero: true })
        }
      }
    };
  }

  new Chart(document.getElementById('chartMatRollingU'), {
    type: 'line',
    data: { labels: MAT_DIC_LABELS, datasets: makeDs(seg.u, false) },
    options: dicOpts(false)
  });
  new Chart(document.getElementById('chartMatRollingMs'), {
    type: 'line',
    data: { labels: MAT_DIC_LABELS, datasets: makeDs(seg.ms, true) },
    options: dicOpts(true)
  });
}

// ─── FULL NAC MARKET CHART ────────────────────────────────────
const NAC_LABELS = ["Feb 2021","Mar 2021","Apr 2021","May 2021","Jun 2021","Jul 2021","Aug 2021","Sep 2021","Oct 2021","Nov 2021","Dec 2021","Jan 2022","Feb 2022","Mar 2022","Apr 2022","May 2022","Jun 2022","Jul 2022","Aug 2022","Sep 2022","Oct 2022","Nov 2022","Dec 2022","Jan 2023","Feb 2023","Mar 2023","Apr 2023","May 2023","Jun 2023","Jul 2023","Aug 2023","Sep 2023","Oct 2023","Nov 2023","Dec 2023","Jan 2024","Feb 2024","Mar 2024","Apr 2024","May 2024","Jun 2024","Jul 2024","Aug 2024","Sep 2024","Oct 2024","Nov 2024","Dec 2024","Jan 2025","Feb 2025","Mar 2025","Apr 2025","May 2025","Jun 2025","Jul 2025","Aug 2025","Sep 2025","Oct 2025","Nov 2025","Dec 2025","Jan 2026"];
const NAC_RX    = [119242,167895,237639,275635,261170,265027,281954,274394,283817,278480,236890,415636,236069,351602,415172,579371,652901,581276,410605,403843,472610,364425,262894,149728,107444,199148,306874,452392,584022,507299,432036,401414,334191,216511,161539,152217,133133,151466,232009,505901,618387,517902,432875,394141,303259,205827,179779,149682,174067,277347,418145,442785,599439,599285,376794,392299,315626,242486,192121,145984];
const NAC_VL    = [4216,6656,8368,9018,7940,8717,10960,15234,15639,13077,10804,29840,19353,37466,39697,58097,66787,48031,30157,35206,42260,33737,19053,15648,20586,24154,26711,41821,52703,44371,36690,33270,27194,18692,12495,10552,9160,12974,19632,44259,50867,34529,31384,28986,21770,15477,6153,7573,13620,16814,19302,17135,26975,26515,13771,12551,11702,10108,5382,6211];
const NAC_MS    = [87.3,87.0,87.2,87.2,87.0,88.1,87.3,85.0,85.8,86.4,87.0,88.2,83.2,86.1,84.9,86.1,84.9,85.3,86.0,87.2,87.1,85.3,89.8,85.2,79.9,84.5,86.6,86.7,85.8,85.4,85.9,86.4,86.4,85.7,87.4,87.7,86.4,85.9,87.3,87.3,84.4,86.3,86.2,86.3,85.4,87.7,88.4,88.5,80.9,82.7,84.2,84.7,84.6,86.5,85.4,85.8,86.4,88.4,88.1,87.5];

new Chart(document.getElementById('chartNacTotal'), {
  type: 'bar',
  data: {
    labels: NAC_LABELS,
    datasets: [
      {
        label: 'Bajo Receta (ETICO)',
        data: NAC_RX,
        backgroundColor: '#8B1C1C',
        borderWidth: 0,
        order: 2,
        yAxisID: 'yU',
      },
      {
        label: 'Venta Libre (VL)',
        data: NAC_VL,
        backgroundColor: '#8B1C1C44',
        borderWidth: 0,
        order: 2,
        yAxisID: 'yU',
      },
      {
        label: 'MS% Acemuk Total',
        data: NAC_MS,
        type: 'line',
        borderColor: '#2563eb',
        backgroundColor: 'transparent',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: '#2563eb',
        tension: 0.35,
        order: 1,
        yAxisID: 'yMs',
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: { padding: { bottom: 28 } },
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#fff',
        borderColor: '#e2e4e8',
        borderWidth: 1,
        padding: 10,
        titleColor: '#1a1d23',
        bodyColor: '#6b7280',
        titleFont: { family: "'Plus Jakarta Sans', sans-serif", weight: '700', size: 12 },
        bodyFont: { family: "'Plus Jakarta Sans', sans-serif", size: 11 },
        callbacks: {
          label: ctx => {
            if (ctx.dataset.yAxisID === 'yMs') return ` MS% Acemuk: ${ctx.parsed.y.toFixed(1)}%`;
            const v = ctx.parsed.y;
            return ` ${ctx.dataset.label}: ${v.toLocaleString('es-AR')} u.`;
          },
          afterBody: ctx => {
            const rx = ctx.find(c => c.datasetIndex === 0)?.parsed.y || 0;
            const vl = ctx.find(c => c.datasetIndex === 1)?.parsed.y || 0;
            const total = rx + vl;
            return total > 0 ? [`─────────────`, ` Total NAC: ${total.toLocaleString('es-AR')} u.`] : [];
          }
        }
      },
      // Inflection annotation for Acemuk VL launch Jan 2025
      annotation: undefined
    },
    scales: {
      x: {
        stacked: true,
        grid: { display: false },
        border: { display: false },
        ticks: {
          maxTicksLimit: 20,
          callback(val, i) {
            const l = this.getLabelForValue(i);
            return l && l.startsWith('Jan') ? l : (l && l.startsWith('Jul') ? l.split(' ')[0] : '');
          },
          font: { size: 10, family: "'Plus Jakarta Sans', sans-serif" },
          color: ctx => {
            const l = ctx.tick?.label;
            return typeof l === 'string' && l.startsWith('Jan') ? '#374151' : '#9ca3af';
          },
          maxRotation: 0,
        }
      },
      yU: {
        stacked: true,
        position: 'left',
        grid: { color: '#f3f4f6' },
        border: { display: false },
        ticks: {
          callback: v => v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v,
          font: { size: 10 },
          color: '#6b7280',
        },
        title: { display: true, text: 'Unidades', font: { size: 10, family: "'Plus Jakarta Sans', sans-serif" }, color: '#9ca3af' }
      },
      yMs: {
        position: 'right',
        min: 60, max: 100,
        grid: { drawOnChartArea: false },
        border: { display: false },
        ticks: {
          callback: v => v + '%',
          font: { size: 10 },
          color: '#2563eb',
        },
        title: { display: true, text: 'MS% Acemuk', font: { size: 10, family: "'Plus Jakarta Sans', sans-serif" }, color: '#2563eb' }
      }
    }
  },
  plugins: [{
    id: 'nacYearStrip',
    beforeDatasetsDraw(chart) {
      const ctx = chart.ctx;
      const labels = chart.data.labels || [];
      const { top, bottom } = chart.chartArea;
      ctx.save();
      ['2022','2023','2024','2025','2026'].forEach(yr => {
        const idx = labels.findIndex(l => l.startsWith('Jan ' + yr));
        if (idx === -1 || !chart.getDatasetMeta(0)?.data[idx]) return;
        const x = chart.getDatasetMeta(0).data[idx].x;
        ctx.beginPath(); ctx.setLineDash([3,4]);
        ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 1;
        ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
        ctx.setLineDash([]);
      });
      ctx.restore();
    },
    afterDraw(chart) {
      const ctx = chart.ctx;
      const labels = chart.data.labels || [];
      const { left, right, bottom } = chart.chartArea;
      const stripH = 18, stripY = bottom + 4;
      const years = ['2021','2022','2023','2024','2025','2026'];
      ctx.save();
      years.forEach((yr, yi) => {
        const startIdx = labels.findIndex(l => l.includes(yr));
        const endIdx   = labels.reduce((acc, l, i) => l.includes(yr) ? i : acc, -1);
        if (startIdx === -1) return;
        const meta = chart.getDatasetMeta(0);
        if (!meta?.data[startIdx]) return;
        const step = startIdx > 0 ? (meta.data[startIdx].x - meta.data[startIdx-1].x) / 2 : 0;
        const x1 = Math.max(meta.data[startIdx].x - step, left);
        const x2 = endIdx < labels.length - 1
          ? Math.min(meta.data[endIdx].x + (meta.data[endIdx+1].x - meta.data[endIdx].x) / 2, right)
          : Math.min(meta.data[endIdx].x + step, right);
        if (x2 <= x1) return;
        ctx.fillStyle = yi % 2 === 0 ? '#f3f4f6' : '#e9eaec';
        ctx.fillRect(x1, stripY, x2 - x1, stripH);
        ctx.fillStyle = '#6b7280';
        ctx.font = "700 10px 'Plus Jakarta Sans', sans-serif";
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(yr, (x1 + x2) / 2, stripY + stripH / 2);
      });
      // VL inflection
      const idx = labels.indexOf('Jan 2025');
      if (idx !== -1 && chart.getDatasetMeta(0)?.data[idx]) {
        const x = chart.getDatasetMeta(0).data[idx].x;
        const { top } = chart.chartArea;
        ctx.fillStyle = 'rgba(37,99,235,0.04)';
        ctx.fillRect(x, top, right - x, bottom - top);
        ctx.beginPath(); ctx.setLineDash([5,4]);
        ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 1.5;
        ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
        ctx.setLineDash([]);
        const bw=84, bh=18, bx=x+5, by=top+8;
        ctx.fillStyle='#2563eb'; ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,3); ctx.fill();
        ctx.fillStyle='#fff'; ctx.font="600 10px 'Plus Jakarta Sans',sans-serif"; ctx.textBaseline='middle';
        ctx.fillText('→ Acemuk VL', bx+6, by+bh/2);
      }
      ctx.restore();
    }
  }]
});
const MAT_SNAP_YEARS = ['2022','2023','2024','2025'];

const MAT_RX_DATA = [
  { label: 'ACEMUK (SIE)',         ms: [86.3,86.6,86.4,85.8], color: '#8B1C1C', sie: true },
  { label: 'TOFLUX (CSO)',         ms: [6.4,7.4,7.5,6.7],     color: '#2563eb' },
  { label: 'TUKOL AC 600 (G3A)',  ms: [0,0,0,3.0],            color: '#16a34a' },
  { label: 'TOFLUX JARABE (CSO)', ms: [2.6,1.6,1.2,0.9],     color: '#d97706' },
  { label: 'DOSOMUK (BET)',        ms: [0.9,1.3,1.6,1.0],     color: '#7c3aed' },
  { label: 'QURA MUK (BEB)',       ms: [1.0,0.7,0.7,0.5],     color: '#0891b2' },
  { label: 'BISTRONFOR (ISA)',     ms: [0.5,0.7,0.4,0.5],     color: '#be185d' },
  { label: 'BRONCOLIUM (T.L)',     ms: [0.6,0.5,0.4,0.5],     color: '#059669' },
  { label: 'DENVERMUC (DEN)',      ms: [0.3,0.5,0.5,0.4],     color: '#6b7280' },
  { label: 'DEXALERGIN MUC (TEV)',ms: [0,0,0.1,0.4],          color: '#9333ea' },
  { label: 'Otros',                ms: [1.7,1.2,1.7,0.7],     color: '#9ca3af' },
];
const MAT_VL_DATA = [
  { label: 'ACEMUK VL (SIE)',    ms: [83.9,77.6,85.0,75.4],  color: '#8B1C1C', sie: true },
  { label: 'TOFLUX VL (CSO)',    ms: [10.9,10.6,10.7,7.1],   color: '#2563eb' },
  { label: 'CEDRIMUC (ELE)',     ms: [5.2,11.8,4.3,8.0],     color: '#7c3aed' },
  { label: 'TUKOL AC 200 (G3A)',ms: [0,0,0,9.5],             color: '#16a34a' },
];

function deltaTag(prev, curr) {
  if (prev === 0 && curr === 0) return '';
  const d = curr - prev;
  if (Math.abs(d) < 0.05) return '<span class="mat-delta flat">→</span>';
  const abs = Math.abs(d).toFixed(1);
  return d > 0
    ? '<span class="mat-delta up">▲ ' + abs + 'pp</span>'
    : '<span class="mat-delta down">▼ ' + abs + 'pp</span>';
}

function buildMatTable(containerId, rows) {
  let html = '<table class="mat-table"><thead><tr><th>Producto</th>' +
    MAT_SNAP_YEARS.map(y => '<th>MAT Dic ' + y + '</th>').join('') +
    '<th>Var 22→25</th></tr></thead><tbody>';

  rows.forEach(row => {
    const cls = row.sie ? 'sie-row' : '';
    const vcls = row.sie ? 'sie-val' : '';
    html += '<tr><td><div class="mat-prod ' + cls + '"><span class="dot" style="background:' + row.color + '"></span>' + row.label + '</div></td>';
    MAT_SNAP_YEARS.forEach((y, i) => {
      const v = row.ms[i];
      const valStr = v > 0 ? '<span class="mat-val ' + vcls + '">' + v.toFixed(1) + '%</span>' : '<span style="color:var(--muted2)">—</span>';
      const delta = i > 0 ? ' ' + deltaTag(row.ms[i-1], v) : '';
      html += '<td>' + valStr + delta + '</td>';
    });
    html += '<td>' + deltaTag(row.ms[0], row.ms[3]) + '</td></tr>';
  });

  html += '</tbody></table>';
  document.getElementById(containerId).innerHTML = html;
}

buildMatTable('tableMatRx', MAT_RX_DATA);
buildMatTable('tableMatVl', MAT_VL_DATA);
buildMatRollingCharts();

// ─── COMPETITOR UNITS CHART ───────────────────────────────────
const COMP_DATA = {
  "ACEMUK Total (SIE)": [107760,151794,214538,248095,234086,241076,255582,246313,256958,251861,215533,393074,212456,334928,386349,549104,611320,536599,379002,382853,448526,339436,253307,140851,102301,188779,288725,428339,546104,470949,402721,375415,312242,201666,152108,142669,122960,141318,219617,480176,564630,476777,400352,365141,277596,194160,164434,139183,151859,243377,368433,389734,529782,541254,333521,347288,282841,223386,173958,133178],
  "TOFLUX Total (CSO)":  [9339,12386,16393,18979,19593,19489,21694,24451,23963,22887,18467,27001,21680,30230,40806,54328,76128,69502,40865,38586,49973,45842,18036,12838,9486,16041,27863,44908,63700,53236,44297,40901,36101,22684,14609,13210,10765,13572,20068,47046,72864,49047,40715,37164,28890,17200,13649,10312,9724,21240,34824,39036,50335,41040,32844,34360,26464,17786,13943,10576],
  "TUKOL (G3A)":         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,18301,15619,17185,13374,21331,23975,9460,8318,6588,3646,3486,1498],
  "CEDRIMUC (ELE)":      [494,1099,1235,1654,1246,915,1148,5568,5218,2747,3450,1701,2768,4799,1596,2597,3338,1877,1729,759,900,700,1066,4910,11661,6954,1634,1292,2678,4757,3513,1907,1247,744,494,399,282,309,528,2106,1533,2457,1877,1081,897,519,377,1784,1650,2115,895,1398,1824,1809,918,858,676,489,146,495],
  "DOSOMUK (BET)":       [600,667,2341,2807,2512,2296,1985,2093,2243,1422,1349,3395,2332,1684,6378,6248,3943,6939,2696,4314,2584,2339,2445,1452,1218,4052,4447,5492,6811,7438,4324,4910,3161,3765,2305,1949,2678,4307,5081,7918,9944,7351,7058,5417,5076,2129,1609,1282,1327,2926,5579,4459,5763,5358,3518,4080,2442,1471,1567,3082],
  "QURA MUK (BEB)":      [1481,2333,3190,4074,3068,3052,3119,2730,3185,2733,1967,6032,4636,5926,7944,7752,4663,327,2036,2762,2976,2394,1547,958,558,1069,1828,2748,3907,3985,3483,3228,2427,1573,990,1201,807,847,1229,3539,5430,3937,3351,2892,2024,1183,872,652,576,1633,1997,2094,3048,2227,2043,2029,1334,971,787,564],
  "Otros":               [3621,6006,8036,8906,8563,6880,9361,8459,7888,9907,6924,14241,11537,11473,11796,17439,20296,14063,14434,9775,9911,7451,5546,4367,2806,6407,9088,11434,13525,11305,10388,8323,6207,4771,3528,3341,4801,4087,5118,9375,14853,12862,10906,11432,10546,6113,4991,4042,4250,7251,8534,9825,14331,10137,8223,7914,6983,4845,3615,2802],
};
const COMP_MS = {
  "ACEMUK Total (SIE)": [87.4,87.1,87.3,87.2,87.0,88.1,87.3,85.0,85.8,86.4,87.0,88.2,83.2,86.1,84.9,86.1,84.9,85.3,86.0,87.2,87.1,85.3,89.8,85.2,79.9,84.5,86.6,86.7,85.8,85.4,85.9,86.4,86.4,85.7,87.4,87.7,86.4,85.9,87.3,87.3,84.4,86.3,86.2,86.3,85.4,87.7,88.4,88.5,80.9,82.7,84.2,84.7,84.6,86.5,85.4,85.8,86.4,88.4,88.1,87.5],
  "TOFLUX Total (CSO)":  [7.6,7.1,6.7,6.7,7.3,7.1,7.4,8.4,8.0,7.8,7.5,6.1,8.5,7.8,9.0,8.5,10.6,11.0,9.3,8.8,9.7,11.5,6.4,7.8,7.4,7.2,8.4,9.1,10.0,9.6,9.5,9.4,10.0,9.6,8.4,8.1,7.6,8.3,8.0,8.6,10.9,8.9,8.8,8.8,8.9,7.8,7.3,6.6,5.2,7.2,8.0,8.5,8.0,6.6,8.4,8.5,8.1,7.0,7.1,6.9],
  "TUKOL (G3A)":         [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9.8,5.3,3.9,2.9,3.4,3.8,2.4,2.1,2.0,1.4,1.8,1.0],
  "CEDRIMUC (ELE)":      [0.4,0.6,0.5,0.6,0.5,0.3,0.4,1.9,1.7,0.9,1.4,0.4,1.1,1.2,0.4,0.4,0.5,0.3,0.4,0.2,0.2,0.2,0.4,3.0,9.1,3.1,0.5,0.3,0.4,0.9,0.7,0.4,0.3,0.3,0.3,0.2,0.2,0.2,0.2,0.4,0.2,0.4,0.4,0.3,0.3,0.2,0.2,1.1,0.9,0.7,0.2,0.3,0.3,0.3,0.2,0.2,0.2,0.2,0.1,0.3],
  "DOSOMUK (BET)":       [0.5,0.4,1.0,1.0,0.9,0.8,0.7,0.7,0.7,0.5,0.5,0.8,0.9,0.4,1.4,1.0,0.5,1.1,0.6,1.0,0.5,0.6,0.9,0.9,1.0,1.8,1.3,1.1,1.1,1.3,0.9,1.1,0.9,1.6,1.3,1.2,1.9,2.6,2.0,1.4,1.5,1.3,1.5,1.3,1.6,1.0,0.9,0.8,0.7,1.0,1.3,1.0,0.9,0.9,0.9,1.0,0.7,0.6,0.8,2.0],
  "QURA MUK (BEB)":      [1.2,1.3,1.3,1.4,1.1,1.1,1.1,0.9,1.1,0.9,0.8,1.4,1.8,1.5,1.7,1.2,0.6,0.1,0.5,0.6,0.6,0.6,0.5,0.6,0.4,0.5,0.5,0.6,0.6,0.7,0.7,0.7,0.7,0.7,0.6,0.7,0.6,0.5,0.5,0.6,0.8,0.7,0.7,0.7,0.6,0.5,0.5,0.4,0.3,0.6,0.5,0.5,0.5,0.4,0.5,0.5,0.4,0.4,0.4,0.4],
  "Otros":               [2.9,3.4,3.3,3.1,3.2,2.5,3.2,2.9,2.6,3.4,2.8,3.2,4.5,2.9,2.6,2.7,2.8,2.2,3.3,2.2,1.9,1.9,2.0,2.6,2.2,2.9,2.7,2.3,2.1,2.0,2.2,1.9,1.7,2.0,2.0,2.1,3.4,2.5,2.0,1.7,2.2,2.3,2.3,2.7,3.2,2.8,2.7,2.6,2.3,2.5,2.0,2.1,2.3,1.6,2.1,2.0,2.1,1.9,1.8,1.8],
};
const COMP_COLORS = {
  "ACEMUK Total (SIE)": '#8B1C1C',
  "TOFLUX Total (CSO)":  '#2563eb',
  "TUKOL (G3A)":         '#16a34a',
  "CEDRIMUC (ELE)":      '#7c3aed',
  "DOSOMUK (BET)":       '#d97706',
  "QURA MUK (BEB)":      '#0891b2',
  "Otros":               '#9ca3af',
};

// Filter full NAC data to activeYears + activeComps (by label mapping)
const COMP_LABEL_MAP = {
  "ACEMUK Total (SIE)": ["ACEMUK (SIE)", "ACEMUK VL (SIE)"],
  "TOFLUX Total (CSO)":  ["TOFLUX (CSO)", "TOFLUX JARABE (CSO)", "TOFLUX VL (CSO)"],
  "TUKOL (G3A)":         ["TUKOL AC 600 (G3A)", "TUKOL AC 200 (G3A)"],
  "CEDRIMUC (ELE)":      ["CEDRIMUC (ELE)"],
  "DOSOMUK (BET)":       ["DOSOMUK (BET)"],
  "QURA MUK (BEB)":      ["QURA MUK (BEB)"],
  "Otros":               null,
};

function isCompActive(compLabel) {
  const mapped = COMP_LABEL_MAP[compLabel];
  if (!mapped) return true; // always show Otros
  return mapped.some(l => activeComps.has(l));
}

function filterCompData(dataObj) {
  const activeIdxs = NAC_LABELS.reduce((acc, l, i) => {
    if (activeYears.has(l.split(' ')[1])) acc.push(i);
    return acc;
  }, []);
  const labels = activeIdxs.map(i => NAC_LABELS[i]);
  const filtered = {};
  Object.entries(dataObj).forEach(([k, arr]) => {
    if (isCompActive(k)) filtered[k] = activeIdxs.map(i => arr[i]);
  });
  return { labels, filtered };
}

function makeCompDs(dataObj) {
  return Object.entries(dataObj).map(([label, data]) => {
    const isSie = label.includes('(SIE)');
    return {
      label, data,
      borderColor: COMP_COLORS[label],
      backgroundColor: isSie ? COMP_COLORS[label] + '15' : 'transparent',
      borderWidth: isSie ? 2.5 : 1.5,
      pointRadius: 0, pointHoverRadius: 5,
      pointHoverBackgroundColor: COMP_COLORS[label],
      tension: 0.35, fill: isSie,
    };
  });
}

function makeCompOpts(isMs, suffix) {
  const yearDivPlugin = {
    id: 'ydiv' + suffix,
    beforeDatasetsDraw(chart) {
      // Draw vertical dividers between years
      const ctx = chart.ctx;
      const labels = chart.data.labels || [];
      const { top, bottom } = chart.chartArea;
      ctx.save();
      ['2022','2023','2024','2025','2026'].forEach(yr => {
        const idx = labels.findIndex(l => l.startsWith('Jan ' + yr));
        if (idx === -1 || !chart.getDatasetMeta(0)?.data[idx]) return;
        const x = chart.getDatasetMeta(0).data[idx].x;
        ctx.beginPath();
        ctx.setLineDash([3, 4]);
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 1;
        ctx.moveTo(x, top); ctx.lineTo(x, bottom);
        ctx.stroke();
        ctx.setLineDash([]);
      });
      ctx.restore();
    },
    afterDraw(chart) {
      // Draw year strip below chart area
      const ctx = chart.ctx;
      const labels = chart.data.labels || [];
      const { left, right, bottom } = chart.chartArea;
      const stripH = 18, stripY = bottom + 4;
      const years = ['2021','2022','2023','2024','2025','2026'];
      ctx.save();
      years.forEach((yr, yi) => {
        const startIdx = labels.findIndex(l => l.includes(yr));
        const endIdx   = labels.reduce((acc, l, i) => l.includes(yr) ? i : acc, -1);
        if (startIdx === -1) return;
        const meta = chart.getDatasetMeta(0);
        if (!meta?.data[startIdx]) return;
        const step = startIdx > 0 ? (meta.data[startIdx].x - meta.data[startIdx - 1].x) / 2 : 0;
        const x1 = Math.max(meta.data[startIdx].x - step, left);
        const x2 = endIdx < labels.length - 1
          ? Math.min(meta.data[endIdx].x + (meta.data[endIdx + 1].x - meta.data[endIdx].x) / 2, right)
          : Math.min(meta.data[endIdx].x + step, right);
        if (x2 <= x1) return;
        ctx.fillStyle = yi % 2 === 0 ? '#f3f4f6' : '#e9eaec';
        ctx.fillRect(x1, stripY, x2 - x1, stripH);
        ctx.fillStyle = '#6b7280';
        ctx.font = "700 10px 'Plus Jakarta Sans', sans-serif";
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(yr, (x1 + x2) / 2, stripY + stripH / 2);
      });
      ctx.restore();
    }
  };

  const vlPlugin = {
    id: 'vlinf' + suffix,
    afterDatasetsDraw(chart) {
      const labels = chart.data.labels || [];
      const idx = labels.indexOf('Jan 2025');
      if (idx === -1) return;
      const meta = chart.getDatasetMeta(0);
      if (!meta?.data[idx]) return;
      const x = meta.data[idx].x;
      const { top, bottom } = chart.chartArea;
      const ctx = chart.ctx;
      ctx.save();
      ctx.fillStyle = 'rgba(139,28,28,0.04)';
      ctx.fillRect(x, top, chart.chartArea.right - x, bottom - top);
      const bw=84, bh=18, bx=x+5, by=top+28;
      ctx.fillStyle='#8B1C1C';
      ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,3); ctx.fill();
      ctx.fillStyle='#fff';
      ctx.font="600 10px \'Plus Jakarta Sans\',sans-serif";
      ctx.textBaseline='middle';
      ctx.fillText('→ Acemuk VL', bx+6, by+bh/2);
      ctx.restore();
    }
  };

  return {
    options: {
      responsive: true, maintainAspectRatio: false,
      layout: { padding: { bottom: 28 } },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: true, position: 'bottom',
          labels: { boxWidth: 10, boxHeight: 10, padding: 12, font: { size: 10, family: "'Plus Jakarta Sans',sans-serif" }, color: '#6b7280', usePointStyle: true, pointStyle: 'circle' }
        },
        tooltip: {
          backgroundColor: '#fff', borderColor: '#e2e4e8', borderWidth: 1, padding: 10,
          titleColor: '#1a1d23', bodyColor: '#6b7280',
          titleFont: { family: "'Plus Jakarta Sans',sans-serif", weight: '700', size: 12 },
          bodyFont: { family: "'Plus Jakarta Sans',sans-serif", size: 11 },
          callbacks: {
            label: ctx => {
              const v = ctx.parsed.y;
              if (!v) return null;
              return isMs ? ` ${ctx.dataset.label}: ${v.toFixed(1)}%` : ` ${ctx.dataset.label}: ${v.toLocaleString('es-AR')} u.`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false }, border: { display: false },
          ticks: {
            maxTicksLimit: 24,
            callback(val, i) {
              const l = this.getLabelForValue(i);
              if (!l) return '';
              if (l.startsWith('Jan')) return '';
              if (l.startsWith('Jul')) return 'Jul';
              return '';
            },
            font: { size: 9, family: "'Plus Jakarta Sans',sans-serif" },
            color: '#9ca3af', maxRotation: 0,
          }
        },
        y: {
          grid: { color: '#f3f4f6' }, border: { display: false },
          ticks: {
            callback: isMs ? v => v + '%' : v => v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v,
            font: { size: 10 }, color: '#6b7280',
          },
          ...(isMs ? { min: 0, max: 100 } : { beginAtZero: true })
        }
      }
    },
    plugins: [yearDivPlugin, vlPlugin]
  };
}

function buildCompCharts() {
  ['chartCompUnits','chartCompMs'].forEach(id => { const c = Chart.getChart(id); if (c) c.destroy(); });
  const { labels: lU, filtered: fu } = filterCompData(COMP_DATA);
  const { labels: lMs, filtered: fms } = filterCompData(COMP_MS);
  const { options: optsU, plugins: pluginsU } = makeCompOpts(false, 'U');
  new Chart(document.getElementById('chartCompUnits'), { type: 'line', data: { labels: lU, datasets: makeCompDs(fu) }, options: optsU, plugins: pluginsU });
  const { options: optsMs, plugins: pluginsMs } = makeCompOpts(true, 'Ms');
  new Chart(document.getElementById('chartCompMs'),    { type: 'line', data: { labels: lMs, datasets: makeCompDs(fms) }, options: optsMs, plugins: pluginsMs });
}
buildCompCharts();

// ─── Init ─────────────────────────────────────────────────────
renderKpi();
renderCompPills();
</script>
</body>
</html>
